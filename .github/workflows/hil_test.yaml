name: STM32 HIL Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: [self-hosted, stm32-board]

    steps:
      - name: Cleanup previous build 
        run: |
          # Delete the previous firmware build directory (Fix Permission Denied).
          rm -rf firmware/build || true
          
      - name: Checkout code
        # Fetch the repository source code so the runner can build and test it.
        uses: actions/checkout@v4

      - name: Build and Run CI Tests
        run: |
          # Build the CI Docker image (unit tests / host tests).
          # Run the container and remove it after it exits.
          docker build -t bmp280-ci -f docker/ci.Dockerfile .
          docker run --rm bmp280-ci
      
      - name: Build Firmware with Docker
        run: |
          # Build firmware inside the Docker Compose "builder" service.
          # Run the container as the runner user (not root) so firmware/build
          # is not created with root ownership (avoids permission issues later).
          docker compose run --rm --user "$(id -u):$(id -g)" builder make -C firmware clean all
        
      - name: Run HIL Test
        # Create a Python virtual environment (venv) on the host if it doesn't exist.
        # Activate it, upgrade pip, install dependencies, then run the HIL script.
        run: |
          # Ensure python3-venv is installed on the host machine
          # Create the virtual environment if it doesn't exist
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi
          
          # Activate the virtual environment
          source venv/bin/activate
          
          # Upgrade pip and install required libraries
          pip install --upgrade pip
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt
          fi
          
          # Run the HIL test script
          python3 scripts/flash_and_test.py
